<main class="newsfeed">
  <% if (posts.length === 0) { %>
    <div style="text-align: center; margin-top: 3rem; color: rgba(255, 255, 255, 0.6); font-size: 1.1rem;">
      ðŸš« No posts yet. Stay tuned!
    </div>
  <% } else { %>
    <% posts.forEach(post => { %>
      <div class="post" data-href="/post?postId=<%= post.post_id %>" style="cursor: pointer;">
        
        <div class="post-header">
          <div class="post-user-info">
            <a href="/profile?acode=<%= post.acode %>">
              <div class="post-profile-pic" style="background-image: url('<%= post.posterPfpUrl %>');"></div>
            </a>
            <a href="/profile?acode=<%= post.acode %>" class="post-username">
              <%= post.displayName %>
            </a>
          </div>
          <div class="post-dropdown">
            <i class="fas fa-ellipsis-v post-dropdown-toggle"></i>
            <div class="post-dropdown-menu">
              <a href="#">Save</a>
              <a href="#">Report</a>
            </div>
          </div>
        </div>

        <p><%= post.caption %></p>

        <% if (post.images.length > 0) { 
     const filenames = post.images.map(url => url.split('/').pop());
     const visibleImages = filenames.slice(0, 4);
     const hiddenCount = filenames.length - 4;
%>
  <div class="post-collage collage-<%= Math.min(4, filenames.length) %>">
    <% visibleImages.forEach((filename, index) => { %>
      <div class="collage-image-wrapper">
        <img src="/media/image/<%= filename %>" alt="Post image" class="collage-image" data-media-index="<%= index %>" />
        <% if (index === 3 && hiddenCount > 0) { %>
          <div class="more-overlay">+<%= hiddenCount %></div>
        <% } %>
      </div>
    <% }) %>
  </div>
<% } %>



        <% post.tracks.forEach(trackUrl => {
             const filename = trackUrl.split('/').pop(); %>
          <audio controls src="/media/audio/<%= filename %>"></audio>
        <% }) %>

        <% post.videos.forEach(videoUrl => {
             const filename = videoUrl.split('/').pop(); %>
          <video controls src="/media/video/<%= filename %>" width="100%"></video>
        <% }) %>

        <div class="timestamp">Posted <%= post.timeAgo %></div>

        <div class="post-actions">
  <button class="post-like-btn" data-post-id="<%= post.post_id %>" title="Like">
    <i class="fa-heart <%= post.isLiked ? 'fa-solid' : 'fa-regular' %>"></i>
    <span><%= post.likeCount %></span>
  </button>

  <button class="post-comment-btn" title="Comment">
    <i class="fa-regular fa-comment"></i>
  </button>

  <button class="post-share-btn" title="Share">
    <i class="fa-regular fa-share-from-square"></i>
  </button>
</div>

      </div>
    <% }) %>
  <% } %>
</main>


<div id="lightboxModal" class="lightbox-modal hidden">
  <div class="lightbox-content">
    <span class="lightbox-close">&times;</span>
    <img id="lightboxImg" src="" alt="Expanded Image" />
    <button class="lightbox-prev">&#10094;</button>
    <button class="lightbox-next">&#10095;</button>
  </div>
</div>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("lightboxModal");
    const modalImg = document.getElementById("lightboxImg");
    const closeBtn = document.querySelector(".lightbox-close");
    const prevBtn = document.querySelector(".lightbox-prev");
    const nextBtn = document.querySelector(".lightbox-next");

    let images = [];
    let currentIndex = 0;

    document.body.addEventListener("click", (e) => {
      const clickedImg = e.target.closest(".collage-image");
      if (!clickedImg) return;

      const postEl = clickedImg.closest(".post");
      const postImages = postEl.querySelectorAll(".collage-image");
      images = Array.from(postImages).map(img => img.src);
      currentIndex = parseInt(clickedImg.dataset.mediaIndex);

      openModal();
    });

    function openModal() {
      modal.classList.remove("hidden");
      updateModalImage();
    }

    function updateModalImage() {
      modalImg.src = images[currentIndex];
    }

    function closeModal() {
      modal.classList.add("hidden");
    }

    closeBtn.addEventListener("click", closeModal);

    nextBtn.addEventListener("click", () => {
      currentIndex = (currentIndex + 1) % images.length;
      updateModalImage();
    });

    prevBtn.addEventListener("click", () => {
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      updateModalImage();
    });

    window.addEventListener("keydown", (e) => {
      if (modal.classList.contains("hidden")) return;
      if (e.key === "Escape") closeModal();
      else if (e.key === "ArrowRight") nextBtn.click();
      else if (e.key === "ArrowLeft") prevBtn.click();
    });
  });
</script>
