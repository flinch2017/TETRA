<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Music Dashboard | TETRA</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>



  <style>
    body {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #0a0f2c;
  color: white;
}

.form-container {
  max-width: 700px;
  margin: 2rem auto;
  padding: 2rem;
  background: rgba(255,255,255,0.05);
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}

.form-container h2 {
  text-align: center;
  margin-bottom: 1.5rem;
}

.form-group {
  margin-bottom: 1rem;
}

.form-group label {
  display: block;
  margin-bottom: 0.4rem;
  color: rgba(255,255,255,0.9);
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 0.5rem;
  border: none;
  border-radius: 6px;
  background: rgba(255,255,255,0.1);
  color: white;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  background: rgba(255,255,255,0.2);
}

.submit-btn {
  display: block;
  width: 100%;
  padding: 0.75rem;
  background-color: #007bff;
  border: none;
  border-radius: 8px;
  color: white;
  font-size: 1rem;
  cursor: pointer;
  margin-top: 1rem;
  transition: background-color 0.2s ease;
}

.submit-btn:hover {
  background-color: #0056b3;
}


.track-item {
  background: rgba(255,255,255,0.08);
  margin-bottom: 0.5rem;
  padding: 0.5rem;
  border-radius: 6px;
  cursor: pointer;
}
.track-meta {
  display: none;
  margin-top: 0.5rem;
  background: rgba(255,255,255,0.05);
  padding: 0.5rem;
  border-radius: 6px;
}


.tracklist-container {
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  margin-top: 0.5rem;
}

.add-track {
  background-color: #007aff;
  color: white;
  padding: 0.6rem;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.95rem;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100%;
  max-width: 300px;
  margin-top: 0.5rem;
  transition: background-color 0.3s;
}

.add-track:hover {
  background-color: #005fc1;
}

.track-card {
  background-color: #1c2a5a;
  border-radius: 8px;
  padding: 0.6rem;
  color: white;
  cursor: pointer;
  transition: background-color 0.3s;
}

.track-card:hover {
  background-color: #25366e;
}

.track-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.track-filename {
  font-size: 0.9rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.track-remove {
  color: rgba(255,255,255,0.8);
  cursor: pointer;
}

.track-remove:hover {
  color: #ff4c4c;
}

.track-fields {
  width: 100%;
  box-sizing: border-box;
  margin-top: 0.6rem;
}

.track-fields input {
  display: block;
  width: 100%;
  box-sizing: border-box;
  padding: 0.6rem 0.8rem;       /* â†‘ more vertical and horizontal padding */
  margin: 0.4rem 0;             /* â†‘ more space between fields */
  border-radius: 6px;           /* slightly rounder corners */
  border: none;
  font-size: 0.95rem;           /* larger text */
  background-color: rgba(255,255,255,0.1);
  color: white;
}


.track-fields input::placeholder {
  color: rgba(255,255,255,0.7);
}


.track-audio {
  width: 100%;
  margin-top: 0.4rem;
  border-radius: 4px;
}


.track-fields select {
  display: block;
  width: 100%;
  box-sizing: border-box;
  padding: 0.6rem 0.8rem;
  margin: 0.4rem 0;
  border-radius: 6px;
  border: none;
  font-size: 0.95rem;
  background-color: rgba(255,255,255,0.1);
  color: white;
}

.track-fields select option {
  color: black; /* keep dropdown list readable */
}

.audio-preview {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 0.6rem;
}

.progress-circle {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: conic-gradient(#007aff 0deg, rgba(255,255,255,0.1) 0deg);
  display: flex;
  align-items: center;
  justify-content: center;
}

.play-btn {
  color: white;
  font-size: 1.2rem;
  cursor: pointer;
}

.upload-progress {
  width: 100%;
  height: 4px;
  background-color: rgba(255,255,255,0.1);
  border-radius: 2px;
  margin-top: 0.4rem;
  overflow: hidden;
  position: relative;
}

.upload-progress::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  height: 100%;
  width: var(--upload-percent, 0%);
  background-color: #007aff;
  transition: width 0.2s linear;
}


select[name="timezone"] {
  color: black;
}

.artwork-upload {
  width: 200px;
  height: 200px;
  border: 2px dashed #ccc;
  border-radius: 8px;
  position: relative;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  background-color: #f9f9f9;
}

.plus-icon {
  font-size: 3rem;
  color: #aaa;
}

.artwork-upload img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}




.drag-container {
  display: flex;
  align-items: center;
  gap: 0.5rem; /* space between lines and number */
  margin-bottom: 0.5rem; /* optional: space below the container */
}

.drag-handle {
  cursor: grab;
  font-size: 1.2rem; /* adjust as needed */
  user-select: none;
}

.track-number {
  font-weight: bold;
  color: #ffffff; /* adjust color */
}

.canvas-upload {
  position: relative;
  width: 200px;       /* adjust size as needed */
  height: 355px;      /* keeps roughly 9:16 */
  border: 2px dashed #ccc;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.canvas-upload .plus-icon {
  font-size: 3rem;
  color: #ccc;
  z-index: 1;
}

.canvas-upload video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.artist-alert {
  background-color: #ffcc00;
  color: #333;
  padding: 8px 12px;
  margin-top: 8px;
  border-radius: 6px;
  font-size: 0.85rem;
  display: flex;
  align-items: center;
  gap: 6px;
  animation: fadeInOut 3s forwards;
}
@keyframes fadeInOut {
  0% { opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { opacity: 0; }
}
/* keep your previous styles */
.primary-artist-container, .featured-artist-container { margin-top: 0.5rem; position: relative; }
.selected-artists, .selected-featured-artists { display: flex; flex-wrap: wrap; margin-top: 0.3rem; gap: 0.3rem; }
.artist-capsule {
  display: inline-flex; align-items: center;
  background: #007aff; color: white; padding: 2px 8px;
  border-radius: 12px; font-size: 0.8rem;
}
.artist-capsule .remove-artist { margin-left: 4px; cursor: pointer; }
.artist-dropdown {
  position: absolute; top: 100%; left: 0;
  background: white; border: 1px solid #ccc;
  width: 100%; max-height: 150px; overflow-y: auto;
  z-index: 10; color: black;
}
.artist-item {
  display: flex; align-items: center;
  padding: 4px 6px; cursor: pointer;
}
.artist-item:hover { background: #f0f0f0; }
.artist-avatar {
  width: 24px; height: 24px;
  border-radius: 50%; margin-right: 6px; object-fit: cover;
}

.no-results-item {
  padding: 6px;
  color: #888;
  text-align: center;
  font-size: 0.85rem;
}

  </style>
</head>
<body>
  <div class="fixed-header">
    <%- include('partials/console_header') %>
  </div>

  <main class="form-container">
  <h2>Single Release</h2>
  
  <form id="releaseForm">

    <div id="releaseWarnings" style="
  display: none; 
  background-color: #fff3cd; 
  color: #856404; 
  border: 1px solid #ffeeba; 
  padding: 10px; 
  margin-bottom: 15px; 
  border-radius: 4px;
  font-size: 0.95rem;
"></div>


    <!-- ðŸŒ± Phase 1: Basic & core info -->
    <h3>Phase 1: Basic Info</h3>

    <div class="form-group" style="display:none;">
      <label>Release ID*</label>
      <input type="text" name="release_id" value="<%= releaseId %>
">
    </div>

    <div class="form-group" style="display:none;">
      <label>Release Type*</label>
      <input type="text" name="release_type" value="Single">
    </div>

    <div class="form-group">
  <label>Artwork (PNG)*</label>
  <small style="display:block; color:#666; font-size:0.9em; margin-bottom:0.4rem;">
    Please ensure your artwork complies with our community guidelines. Non-compliant content may result in removal of your release and suspension of your account. 
    <a href="/community-guidelines" style="color:#007aff; text-decoration:none; margin-left:4px;">See community guidelines</a>
  </small>
  <div class="artwork-upload" id="artworkUpload">
    <span class="plus-icon">+</span>
    <img id="artworkPreview" src="" alt="Artwork Preview" style="display:none;" />
    <input type="file" name="art_url" id="artworkInput" accept="image/png" hidden>
  </div>
</div>






    <div class="form-group">
      <label>Release Title*</label>
      <input type="text" name="release_title" required>
    </div>

    <div class="form-group" style="display:none;">
  <label>Released by*</label>
  <input type="text" name="acode" value="<%= currentUser %>" required>
</div>

    <h3>Phase 2: Upload Tracks</h3>
    <div class="form-group">
  <label>Tracklist*</label>
  <div id="tracklistContainer" class="tracklist-container">
    <!-- tracks will appear here -->
  </div>
  <div class="add-track" id="addTrackBtn">
    <i class="fas fa-plus"></i>
  </div>
</div>




    <!-- âœï¸ Phase 2: Creators & Rights -->
<h3>Phase 3: Creators & Rights</h3>
<div class="form-group">
  <label>Copyright Holder*</label>
  <input type="text" name="copyright" required>
</div>

<div class="form-group">
  <label>Phonograph*</label>
  <input type="text" name="phonograph" required>
</div>


<div class="form-group">
  <label>Record Label (Optional)</label>
  <input type="text" name="record_label">
</div>


    <!-- âš™ï¸ Phase 3: Technical & release details -->
    <h3>Phase 4: Technical & Release Details</h3>

    <div class="form-group">
      <label>UPC/EAN (If available)</label>
      <input type="text" name="upc">
    </div>

    <div class="form-group">
      <label>Musical Key (Optional)</label>
      <input type="text" name="musical_key">
    </div>

    <div class="form-group">
  <label>Canvas (Optional)</label>
  <div class="canvas-upload" id="canvasUpload">
    <span class="plus-icon">+</span>
    <video id="canvasPreview" style="display:none;" muted loop></video>
    <input type="file" name="canvas_url" id="canvasInput" accept="video/mp4" hidden>
  </div>
  <small style="color:#666; font-size:0.9em;">
    Upload an MP4 video (vertical 9:16) lasting between 3â€“8 seconds.
  </small>
</div>



    <div class="form-group">
      <label>Release Date*</label>
      <input type="date" name="release_date" required>
    </div>
    <div class="form-group">
      <label>Release Time*</label>
      <input type="time" name="release_time" required>
    </div>
    <div class="form-group">
      <label>Timezone*</label>
      <select name="release_zone" style="color: black;" required>
  <option value="" disabled selected hidden>Select Timezone</option>
  <option value="UTC">UTC</option>
  <option value="Etc/GMT+12">GMT-12:00 (International Date Line West)</option>
  <option value="Pacific/Honolulu">GMT-10:00 (Hawaii)</option>
  <option value="America/Anchorage">GMT-09:00 (Alaska)</option>
  <option value="America/Los_Angeles">GMT-08:00 (Pacific Time - US & Canada)</option>
  <option value="America/Denver">GMT-07:00 (Mountain Time - US & Canada)</option>
  <option value="America/Chicago">GMT-06:00 (Central Time - US & Canada)</option>
  <option value="America/New_York">GMT-05:00 (Eastern Time - US & Canada)</option>
  <option value="America/Sao_Paulo">GMT-03:00 (Brasilia)</option>
  <option value="Atlantic/Azores">GMT-01:00 (Azores)</option>
  <option value="Europe/London">GMT+00:00 (London)</option>
  <option value="Europe/Berlin">GMT+01:00 (Berlin, Rome, Paris)</option>
  <option value="Europe/Athens">GMT+02:00 (Athens, Bucharest)</option>
  <option value="Europe/Moscow">GMT+03:00 (Moscow, St. Petersburg)</option>
  <option value="Asia/Dubai">GMT+04:00 (Abu Dhabi, Dubai)</option>
  <option value="Asia/Karachi">GMT+05:00 (Islamabad, Karachi)</option>
  <option value="Asia/Dhaka">GMT+06:00 (Dhaka)</option>
  <option value="Asia/Bangkok">GMT+07:00 (Bangkok, Jakarta)</option>
  <option value="Asia/Shanghai">GMT+08:00 (Beijing, Hong Kong, Singapore)</option>
  <option value="Asia/Tokyo">GMT+09:00 (Tokyo, Seoul)</option>
  <option value="Australia/Sydney">GMT+10:00 (Sydney, Melbourne)</option>
  <option value="Pacific/Auckland">GMT+12:00 (Auckland, Wellington)</option>
  <option value="Asia/Manila">GMT+08:00 (Manila)</option>
</select>

    </div>
  

    <button type="submit" class="submit-btn">Add Release</button>

<div id="uploadProgressContainer" style="
  display: none;
  margin-top: 10px;
  background-color: #e9ecef;
  border-radius: 999px;
  overflow: hidden;
  height: 22px;
  box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
">
  <div id="uploadProgressBar" style="
    width: 0%;
    height: 100%;
    background: linear-gradient(90deg, #4facfe, #00f2fe);
    text-align: center;
    color: white;
    font-weight: 500;
    font-size: 0.85rem;
    line-height: 22px;
    white-space: nowrap;
    transition: width 0.3s ease;
  ">0%</div>
</div>


  </form>
</main>

<!-- Alert container -->
<div id="artistAlert" class="artist-alert" style="display:none;">
  âš  Please select an artist from the dropdown list only.
</div>

<script>
const releaseId = "<%= releaseId %>";
const currentUser = "<%= currentUser %>";

const addTrackBtn = document.getElementById('addTrackBtn');
const tracklistContainer = document.getElementById('tracklistContainer');
const uploadedS3Keys = new Set();

const trackOrderInput = document.createElement('input');
trackOrderInput.type = 'hidden';
trackOrderInput.name = 'track_order';
tracklistContainer.appendChild(trackOrderInput);

// Initialize Sortable
const sortable = new Sortable(tracklistContainer, {
  handle: '.drag-handle',
  animation: 150,
  onSort: updateTrackOrder
});

function updateTrackOrder() {
  const cards = Array.from(tracklistContainer.querySelectorAll('.track-card'));
  cards.forEach((card, index) => {
    const num = card.querySelector('.track-number');
    if (num) num.textContent = index + 1;
  });

  const order = cards.map(card => {
    const trackIdField = card.querySelector('input[type="hidden"]'); // get hidden trackId
    return trackIdField ? trackIdField.value : '';
  });
  trackOrderInput.value = order.join(',');
}




function generateUniqueCode(length = 8) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  return Array.from({ length }).map(() => chars[Math.floor(Math.random() * chars.length)]).join('');
}

function saveUploadedKey(key) { if (key) uploadedS3Keys.add(key); }
function removeUploadedKey(key) { uploadedS3Keys.delete(key); }

const artistAlert = document.getElementById('artistAlert');
function showArtistAlert() {
  artistAlert.style.display = 'flex';
  setTimeout(() => { artistAlert.style.display = 'none'; }, 3000);
}

window.addEventListener('beforeunload', () => {
  uploadedS3Keys.forEach(key => {
    const data = JSON.stringify({ key });
    const blob = new Blob([data], { type: 'application/json' });
    navigator.sendBeacon('/delete-track', blob);
  });
});

addTrackBtn.addEventListener('click', () => {
  if (tracklistContainer.querySelectorAll('.track-card').length >= 3) {
    alert('You can only upload up to 3 tracks.');
    return;
  }

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'audio/mpeg';
  input.style.display = 'none';

  input.addEventListener('change', () => {
    if (input.files.length === 0) return;
    const file = input.files[0];
    const trackId = `${releaseId}-${generateUniqueCode(8)}`;

    const card = document.createElement('div'); card.className = 'track-card';

    // Container for drag handle + track number
const dragContainer = document.createElement('div');
dragContainer.className = 'drag-container';

// Drag handle (â˜°)
const dragHandle = document.createElement('div');
dragHandle.className = 'drag-handle';
dragHandle.innerHTML = '&#9776;'; // â˜° icon

// Track order number
const trackNumber = document.createElement('span');
trackNumber.className = 'track-number';
trackNumber.textContent = tracklistContainer.querySelectorAll('.track-card').length + 1;

// Append both to container
dragContainer.appendChild(dragHandle);
dragContainer.appendChild(trackNumber);

// Add to card
card.appendChild(dragContainer);



    const header = document.createElement('div'); header.className = 'track-header';
    const filename = document.createElement('div'); filename.className = 'track-filename'; filename.textContent = file.name;
    const removeBtn = document.createElement('i'); removeBtn.className = 'fas fa-times track-remove';

    removeBtn.addEventListener('click', async () => {
      if (card.dataset.s3Key) {
        await fetch('/delete-track', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ key: card.dataset.s3Key })});
        removeUploadedKey(card.dataset.s3Key);
      }
      tracklistContainer.removeChild(card); tracklistContainer.removeChild(input);
    });

    header.appendChild(filename); header.appendChild(removeBtn); card.appendChild(header);

    // Audio preview
    const preview = document.createElement('div'); preview.className = 'audio-preview';
    const circle = document.createElement('div'); circle.className = 'progress-circle';
    const playBtn = document.createElement('i'); playBtn.className = 'fas fa-play play-btn';
    circle.appendChild(playBtn); preview.appendChild(circle);
    const uploadBar = document.createElement('div'); uploadBar.className = 'upload-progress';
    preview.appendChild(uploadBar); card.appendChild(preview);

    const audio = document.createElement('audio'); audio.src = URL.createObjectURL(file); audio.preload = 'metadata';
    let isPlaying = false;
    playBtn.addEventListener('click', () => isPlaying ? audio.pause() : audio.play());
    audio.addEventListener('play', () => { isPlaying=true; playBtn.classList.replace('fa-play','fa-pause'); });
    audio.addEventListener('pause', () => { isPlaying=false; playBtn.classList.replace('fa-pause','fa-play'); });
    audio.addEventListener('timeupdate', () => {
      const progress = audio.currentTime / audio.duration;
      circle.style.background = `conic-gradient(#007aff ${progress*360}deg, rgba(255,255,255,0.1) ${progress*360}deg)`;
    });

    // Upload
    const xhr = new XMLHttpRequest();
    xhr.open('POST','/upload-track');
    const form = new FormData();
    form.append('track',file); form.append('releaseId',releaseId); form.append('trackId',trackId);
    xhr.upload.onprogress = e => { if(e.lengthComputable){ uploadBar.style.setProperty('--upload-percent',(e.loaded/e.total*100)+'%'); }};
    xhr.onload=()=>{ 
      if(xhr.status===200){ 
        const res=JSON.parse(xhr.responseText); 
        card.dataset.s3Key=res.key; saveUploadedKey(res.key);
      }else{ uploadBar.style.backgroundColor='red'; }
    };
    xhr.send(form);

    // Fields
    const fields=document.createElement('div'); fields.className='track-fields';
    
    const trackIdField = document.createElement('input');
trackIdField.type = 'hidden';
trackIdField.name = 'trackId';
trackIdField.value = trackId;
fields.appendChild(trackIdField);   // âœ… must append so it is included in FormData




    const trackTitleField = document.createElement('input');
trackTitleField.type = 'text';
trackTitleField.placeholder = 'Track Title*';
fields.appendChild(trackTitleField);


    // Primary Artist multi-select
    const primaryContainer=document.createElement('div'); primaryContainer.className='primary-artist-container';
    const primaryInput=document.createElement('input'); primaryInput.type='text'; primaryInput.placeholder='Add Primary Artist*';
    const primarySelectedDiv=document.createElement('div'); primarySelectedDiv.className='selected-artists';
    primaryContainer.appendChild(primaryInput); primaryContainer.appendChild(primarySelectedDiv);
    fields.appendChild(primaryContainer);

    const selectedPrimaryArtists=new Map();
    selectedPrimaryArtists.set(currentUser,'You');

    const hiddenPrimaryAcodesInput = document.createElement('input');
    hiddenPrimaryAcodesInput.type = 'hidden';
    hiddenPrimaryAcodesInput.name = 'primaryArtistAcodes';
    fields.appendChild(hiddenPrimaryAcodesInput);

    function renderPrimarySelected(){
      primarySelectedDiv.innerHTML='';
      selectedPrimaryArtists.forEach((name,acode)=>{
        const span=document.createElement('span'); span.className='artist-capsule'; span.textContent=name;
        if(acode!==currentUser){
          const x=document.createElement('i'); x.className='fas fa-times remove-artist';
          x.onclick=()=>{ selectedPrimaryArtists.delete(acode); renderPrimarySelected(); };
          span.appendChild(x);
        }
        primarySelectedDiv.appendChild(span);
      });
      hiddenPrimaryAcodesInput.value = Array.from(selectedPrimaryArtists.keys()).join(',');
    }
    renderPrimarySelected();

    let primaryDropdown;
    primaryInput.addEventListener('input', async () => {
  const q = primaryInput.value.trim();
  if (!q) { if (primaryDropdown) primaryDropdown.remove(); return; }

  const res = await fetch('/search-artists?q=' + encodeURIComponent(q));
  const list = await res.json();

  if (primaryDropdown) primaryDropdown.remove();
  primaryDropdown = document.createElement('div'); 
  primaryDropdown.className='artist-dropdown';

  let hasResult = false;
  list.forEach(user => {
    const alreadyInPrimary = selectedPrimaryArtists.has(user.acode);
    const alreadyInFeatured = selectedFeaturedArtists.has(user.acode);
    if (!alreadyInPrimary && !alreadyInFeatured) {
      hasResult = true;
      const item=document.createElement('div'); item.className='artist-item';
      const img=document.createElement('img'); img.src=user.pfp_url; img.alt=user.artist_name; img.className='artist-avatar';
      const name=document.createElement('span'); name.textContent=user.artist_name;
      item.appendChild(img); item.appendChild(name);
      item.onclick=()=>{ 
        selectedPrimaryArtists.set(user.acode,user.artist_name); 
        renderPrimarySelected(); 
        primaryInput.value=''; 
        if (primaryDropdown) primaryDropdown.remove(); 
      };
      primaryDropdown.appendChild(item);
    }
  });

  if (!hasResult) {
    const noResultItem = document.createElement('div');
    noResultItem.className = 'no-results-item';
    noResultItem.textContent = 'No results found';
    primaryDropdown.appendChild(noResultItem);
  }

  primaryContainer.appendChild(primaryDropdown);
});

    primaryInput.addEventListener('blur', () => {
  setTimeout(() => {
    if (primaryInput.value.trim()) {
      primaryInput.value = '';
      showArtistAlert();
    }
    if (primaryDropdown) primaryDropdown.remove();
  }, 100);
});


    // Featured Artist multi-select
    const featuredContainer=document.createElement('div'); featuredContainer.className='featured-artist-container';
    const featuredInput=document.createElement('input'); featuredInput.type='text'; featuredInput.placeholder='Add Featured Artist (If any)';
    const featuredSelectedDiv=document.createElement('div'); featuredSelectedDiv.className='selected-featured-artists';
    featuredContainer.appendChild(featuredInput); featuredContainer.appendChild(featuredSelectedDiv);
    fields.appendChild(featuredContainer);

    const selectedFeaturedArtists=new Map();

    const hiddenFeaturedAcodesInput = document.createElement('input');
    hiddenFeaturedAcodesInput.type = 'hidden';
    hiddenFeaturedAcodesInput.name = 'featuredArtistAcodes';
    fields.appendChild(hiddenFeaturedAcodesInput);

    function renderFeaturedSelected(){
      featuredSelectedDiv.innerHTML='';
      selectedFeaturedArtists.forEach((name,acode)=>{
        const span=document.createElement('span'); span.className='artist-capsule'; span.textContent=name;
        const x=document.createElement('i'); x.className='fas fa-times remove-artist';
        x.onclick=()=>{ selectedFeaturedArtists.delete(acode); renderFeaturedSelected(); };
        span.appendChild(x);
        featuredSelectedDiv.appendChild(span);
      });
      hiddenFeaturedAcodesInput.value = Array.from(selectedFeaturedArtists.keys()).join(',');
    }

    let featuredDropdown;
    featuredInput.addEventListener('input', async () => {
  const q = featuredInput.value.trim();
  if (!q) { if (featuredDropdown) featuredDropdown.remove(); return; }

  const res = await fetch('/search-artists?q=' + encodeURIComponent(q));
  const list = await res.json();

  if (featuredDropdown) featuredDropdown.remove();
  featuredDropdown = document.createElement('div'); 
  featuredDropdown.className='artist-dropdown';

  let hasResult = false;
  list.forEach(user => {
    if(user.acode === currentUser) return;
    const alreadyInPrimary = selectedPrimaryArtists.has(user.acode);
    const alreadyInFeatured = selectedFeaturedArtists.has(user.acode);
    if (!alreadyInPrimary && !alreadyInFeatured) {
      hasResult = true;
      const item=document.createElement('div'); item.className='artist-item';
      const img=document.createElement('img'); img.src=user.pfp_url; img.alt=user.artist_name; img.className='artist-avatar';
      const name=document.createElement('span'); name.textContent=user.artist_name;
      item.appendChild(img); item.appendChild(name);
      item.onclick=()=>{ 
        selectedFeaturedArtists.set(user.acode,user.artist_name); 
        renderFeaturedSelected(); 
        featuredInput.value=''; 
        if (featuredDropdown) featuredDropdown.remove(); 
      };
      featuredDropdown.appendChild(item);
    }
  });

  if (!hasResult) {
    const noResultItem = document.createElement('div');
    noResultItem.className = 'no-results-item';
    noResultItem.textContent = 'No results found';
    featuredDropdown.appendChild(noResultItem);
  }

  featuredContainer.appendChild(featuredDropdown);
});

    featuredInput.addEventListener('blur', () => {
  setTimeout(() => {
    if (featuredInput.value.trim()) {
      featuredInput.value = '';
      showArtistAlert();
    }
    if (featuredDropdown) featuredDropdown.remove();
  }, 100);
});


    // Other fields

// Genre dropdown
const genreSelect = document.createElement('select');
genreSelect.name = 'genre';
genreSelect.innerHTML = `
  <option value="" disabled selected hidden>Select Genre*</option>
  <option value="Pop">Pop</option>
  <option value="Rock">Rock</option>
  <option value="Hip Hop">Hip Hop</option>
  <option value="Electronic">Electronic</option>
  <option value="Jazz">Jazz</option>
  <option value="Classical">Classical</option>
  <option value="Country">Country</option>
`;
fields.appendChild(genreSelect);

// Sub-Genre dropdown
const subGenreSelect = document.createElement('select');
subGenreSelect.name = 'subGenre';
subGenreSelect.innerHTML = `
  <option value="" disabled selected hidden>Sub-Genre*</option>
  <option value="Alternative">Alternative</option>
  <option value="Dance">Dance</option>
  <option value="Hip-Hop">Hip-Hop</option>
  <option value="Indie">Indie</option>
  <option value="Metal">Metal</option>
  <option value="Pop">Pop</option>
  <option value="R&B">R&B</option>
  <option value="Rock">Rock</option>
`;
fields.appendChild(subGenreSelect);


// Composer text input
const composerInput = document.createElement('input');
composerInput.type = 'text';
composerInput.placeholder = 'Composer*';
fields.appendChild(composerInput);

// Producer text input
const producerInput = document.createElement('input');
producerInput.type = 'text';
producerInput.placeholder = 'Producer*';
fields.appendChild(producerInput);

// ISRC text input
const isrcInput = document.createElement('input');
isrcInput.type = 'text';
isrcInput.placeholder = 'ISRC (If available)';
isrcInput.name = 'isrc';
fields.appendChild(isrcInput);


// BPM text input
const bpmInput = document.createElement('input');
bpmInput.type = 'number';
bpmInput.placeholder = 'BPM*';
bpmInput.min = '30';
bpmInput.max = '300';
fields.appendChild(bpmInput);


// Mood dropdown
const moodSelect = document.createElement('select');
moodSelect.name = 'mood';
moodSelect.innerHTML = `
  <option value="" disabled selected hidden>Select Mood*</option>
  <option value="Happy">Happy</option>
  <option value="Sad">Sad</option>
  <option value="Energetic">Energetic</option>
  <option value="Calm">Calm</option>
  <option value="Romantic">Romantic</option>
  <option value="Angry">Angry</option>
  <option value="Other">Other</option>
`;
fields.appendChild(moodSelect);

// Explicit dropdown
const explicitSelect = document.createElement('select');
explicitSelect.name = 'explicit';
explicitSelect.innerHTML = `
  <option value="" disabled selected hidden>Is the track explicit?*</option>
  <option value="Yes">Yes</option>
  <option value="Not Explicit">Not Explicit</option>
  <option value="Clean Version">Clean Version</option>
`;
fields.appendChild(explicitSelect);




    header.onclick=e=>{ if(!e.target.classList.contains('track-remove')) fields.style.display=fields.style.display==='none'?'block':'none'; };
    card.appendChild(fields);
    tracklistContainer.appendChild(card);
  });
  tracklistContainer.appendChild(input); input.click();
});
</script>


<script>
const canvasUpload = document.getElementById('canvasUpload');
const canvasInput = document.getElementById('canvasInput');
const canvasPreview = document.getElementById('canvasPreview');
const canvasPlusIcon = canvasUpload.querySelector('.plus-icon'); // renamed

// Clicking the placeholder triggers file input
canvasUpload.addEventListener('click', () => {
  canvasInput.click();
});

canvasInput.addEventListener('change', () => {
  const file = canvasInput.files[0];
  if (!file) return;

  if (file.type !== 'video/mp4') {
    alert('Only MP4 videos are allowed.');
    canvasInput.value = '';
    return;
  }

  const video = document.createElement('video');
  video.preload = 'metadata';

  video.onloadedmetadata = () => {
    window.URL.revokeObjectURL(video.src);

    const duration = video.duration;
    const width = video.videoWidth;
    const height = video.videoHeight;
    const aspectRatio = width / height;

    const targetAspect = 9 / 16;
    const tolerance = 0.01;

    if (duration < 3 || duration > 8) {
      alert('Video must be between 3 and 8 seconds.');
      canvasInput.value = '';
      return;
    }

    if (Math.abs(aspectRatio - targetAspect) > tolerance) {
      alert('Video must be vertical with a 9:16 aspect ratio.');
      canvasInput.value = '';
      return;
    }

    // Passed validation â€” show preview
    const previewURL = URL.createObjectURL(file);
    canvasPreview.src = previewURL;
    canvasPreview.style.display = 'block';
    canvasPreview.play();   // autoplay preview
    canvasPlusIcon.style.display = 'none'; // updated reference
  };

  video.onerror = () => {
    alert('Could not load video. Please upload a valid MP4 file.');
    canvasInput.value = '';
  };

  video.src = URL.createObjectURL(file);
});
</script>

<script>
const artworkUpload = document.getElementById('artworkUpload');
const artworkInput = document.getElementById('artworkInput');
const artworkPreview = document.getElementById('artworkPreview');
const plusIcon = artworkUpload.querySelector('.plus-icon');

artworkUpload.addEventListener('click', () => {
  artworkInput.click();
});

artworkInput.addEventListener('change', () => {
  const file = artworkInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      artworkPreview.src = e.target.result;
      artworkPreview.style.display = 'block';
      plusIcon.style.display = 'none';
    };
    reader.readAsDataURL(file);
  } else {
    artworkPreview.src = '';
    artworkPreview.style.display = 'none';
    plusIcon.style.display = 'block';
  }
});
</script>

<script>
document.getElementById('releaseForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  let messages = [];

  // Validate main form fields
  const artwork = document.querySelector('#artworkInput').files.length;
  if (!artwork) messages.push('â€¢ Please upload artwork.');
  const releaseTitle = document.querySelector('input[name="release_title"]').value.trim();
  if (!releaseTitle) messages.push('â€¢ Please enter Release Title.');
  const releaseDate = document.querySelector('input[name="release_date"]').value;
  if (!releaseDate) messages.push('â€¢ Please select Release Date.');
  const releaseTime = document.querySelector('input[name="release_time"]').value;
  if (!releaseTime) messages.push('â€¢ Please select Release Time.');
  const releaseZone = document.querySelector('select[name="release_zone"]').value;
  if (!releaseZone) messages.push('â€¢ Please select Timezone.');

  const upc = document.querySelector('input[name="upc"]')?.value?.trim();
  if (!upc) messages.push('â€¢ Please enter UPC.');

  // Validate tracks
  const trackCards = document.querySelectorAll('#tracklistContainer .track-card');
  if (trackCards.length === 0) {
    messages.push('â€¢ Please add at least one track.');
  }

  const tracks = [];
  const isrcs = [];
  trackCards.forEach((card, index) => {
    const title = card.querySelector('input[placeholder="Track Title*"]').value.trim();
    const primaryArtistAcodes = card.querySelector('input[name="primaryArtistAcodes"]').value.trim();
    const genre = card.querySelector('select[name="genre"]').value;
    const subGenre = card.querySelector('select[name="subGenre"]').value;
    const composer = card.querySelector('input[placeholder="Composer*"]').value.trim();
    const producer = card.querySelector('input[placeholder="Producer*"]').value.trim();
    const bpm = card.querySelector('input[placeholder="BPM*"]').value.trim();
    const mood = card.querySelector('select[name="mood"]').value;
    const explicit = card.querySelector('select[name="explicit"]').value;
    const trackId = card.querySelector('input[name="trackId"]')?.value;
    const featuredArtistAcodes = card.querySelector('input[name="featuredArtistAcodes"]').value.trim();
    const isrc = card.querySelector('input[name="isrc"]')?.value?.trim();
    const s3Key = card.dataset.s3Key;

    if (!title) messages.push(`â€¢ Track ${index + 1}: Please enter Track Title.`);
    if (!primaryArtistAcodes) messages.push(`â€¢ Track ${index + 1}: Please add at least one Primary Artist.`);
    if (!genre) messages.push(`â€¢ Track ${index + 1}: Please select Genre.`);
    if (!subGenre) messages.push(`â€¢ Track ${index + 1}: Please select Sub-Genre.`);
    if (!composer) messages.push(`â€¢ Track ${index + 1}: Please enter Composer.`);
    if (!producer) messages.push(`â€¢ Track ${index + 1}: Please enter Producer.`);
    if (!bpm) messages.push(`â€¢ Track ${index + 1}: Please enter BPM.`);
    if (!mood) messages.push(`â€¢ Track ${index + 1}: Please select Mood.`);
    if (!explicit) messages.push(`â€¢ Track ${index + 1}: Please select if track is Explicit.`);
    if (isrc) isrcs.push(isrc);

    tracks.push({
      trackId, title, primaryArtistAcodes, featuredArtistAcodes, genre, subGenre, composer, producer, bpm, mood, explicit, isrc, s3Key
    });
  });

  // âœ… Extra warning if there is only one track and titles differ
  if (trackCards.length === 1) {
    const trackTitle = tracks[0].title;
    if (trackTitle.toLowerCase() !== releaseTitle.toLowerCase()) {
      messages.push('â€¢ You have only added one track. Please make sure the Release Title and Track Title match (they currently do not).');
    }
  }

  // NEW: Check ISRC & UPC duplicates
  if (isrcs.length > 0 || upc) {
    try {
      const duplicateResponse = await fetch('/check-duplicates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ isrcs, upc })
      });
      const duplicateResult = await duplicateResponse.json();
      if (duplicateResult.duplicateISRCs && duplicateResult.duplicateISRCs.length > 0) {
        duplicateResult.duplicateISRCs.forEach(d => {
          messages.push(`â€¢ The ISRC "${d}" already exists in the system.`);
        });
      }
      if (duplicateResult.duplicateUPC) {
        messages.push(`â€¢ The UPC "${upc}" already exists in the system.`);
      }
    } catch (error) {
      console.error('Duplicate check error:', error);
      messages.push('â€¢ Could not verify ISRC/UPC duplicates. Please try again later.');
    }
  }

  // Show warnings if any
  const warningBox = document.getElementById('releaseWarnings');
  if (messages.length > 0) {
    warningBox.innerHTML = messages.join('<br>');
    warningBox.style.display = 'block';
    window.scrollTo({ top: warningBox.offsetTop - 20, behavior: 'smooth' });
    return;
  } else {
    warningBox.style.display = 'none';
  }

  // âœ… If validation passed, send data
  updateTrackOrder();
  const formData = new FormData(this);
  formData.append('tracks', JSON.stringify(tracks));

    try {
  const progressContainer = document.getElementById('uploadProgressContainer');
  const progressBar = document.getElementById('uploadProgressBar');
  const submitBtn = document.querySelector('.submit-btn');

  // Reset & show progress, hide button
  progressBar.style.width = '0%';
  progressBar.textContent = '0%';
  submitBtn.style.display = 'none';
  progressContainer.style.display = 'block';

  const xhr = new XMLHttpRequest();
  xhr.open('POST', '/submit-release');

  xhr.upload.addEventListener('progress', function(e) {
    if (e.lengthComputable) {
      const percent = Math.round((e.loaded / e.total) * 100);
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
    }
  });

  xhr.onload = function() {
    try {
      const result = JSON.parse(xhr.responseText);
      if (xhr.status === 200 && result.success) {
        progressBar.style.width = '100%';
        progressBar.textContent = 'Upload complete!';
        setTimeout(() => {
          window.location.href = '/profile?acode=<%= userAcode %>';
        }, 800); // brief pause to show completion
      } else {
        showError(result.message || 'Something went wrong');
      }
    } catch (parseErr) {
      console.error('Parse error:', parseErr);
      showError('Unexpected server response.');
    }
  };

  xhr.onerror = function() {
    showError('Network error. Please try again.');
  };

  xhr.send(formData);

  function showError(message) {
    warningBox.innerHTML = 'â€¢ ' + message;
    warningBox.style.display = 'block';
    submitBtn.style.display = 'block';
    progressContainer.style.display = 'none';
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
  }
} catch (error) {
  console.error('Submit error:', error);
  warningBox.innerHTML = 'â€¢ Server error. Please try again later.';
  warningBox.style.display = 'block';
  submitBtn.style.display = 'block';
  progressContainer.style.display = 'none';
  progressBar.style.width = '0%';
  progressBar.textContent = '0%';
}


});
</script>










</body>
</html>
